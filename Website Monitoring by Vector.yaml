zabbix_export:
  version: '7.0'
  template_groups:
    - uuid: a571c0d144b14fd4a87a9d9b2aa9fcd6
      name: Templates/Applications
  templates:
    - uuid: b94aec557a444f4c92c16531a9cd91a6
      template: 'Website Monitoring by Vector'
      name: 'Website Monitoring by Vector'
      groups:
        - name: Templates/Applications
      items:
        - uuid: fdadae90b1b640fa85a1a86e13a3b5bf
          name: 'Broken link counts'
          type: DEPENDENT
          key: blk.count
          delay: '0'
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.Broken_links_count
          master_item:
            key: 'vu_blk.py[{$WEB.URL}]'
        - uuid: 06c126a9bb97451d936e51e9a39e8f1c
          name: 'Broken Links'
          type: DEPENDENT
          key: blk.link
          delay: '0'
          value_type: LOG
          trends: '0'
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.Broken_Links
              error_handler: DISCARD_VALUE
          master_item:
            key: 'vu_blk.py[{$WEB.URL}]'
        - uuid: b4e72612f99742998f75dae2c31d6650
          name: 'Cert: Expires on'
          type: EXTERNAL
          key: 'checkssl.sh[{$WEB.URL}]'
          delay: 1d
          value_type: FLOAT
          units: days
          description: 'The date on which the certificate validity period ends.'
          timeout: 30s
          triggers:
            - uuid: 53fef5c0342444a2a2c6f96a73e02083
              expression: 'last(/Website Monitoring by Vector/checkssl.sh[{$WEB.URL}])<{$CERT.EXPIRY.WARN}'
              recovery_mode: RECOVERY_EXPRESSION
              recovery_expression: 'last(/Website Monitoring by Vector/checkssl.sh[{$WEB.URL}])>{$CERT.EXPIRY.WARN}'
              name: 'Cert: SSL certificate expires soon'
              event_name: 'Cert: SSL certificate expires soon for {$WEB.URL} (less than {$CERT.EXPIRY.WARN} days)'
              opdata: 'Remaining Days: {ITEM.LASTVALUE}'
              priority: AVERAGE
              description: 'The SSL certificate should be updated or it will become untrusted.'
              tags:
                - tag: Severity
                  value: Average
        - uuid: 8e12a43a61a647eba5363945cb7be4b9
          name: 'DNS Query Time'
          type: EXTERNAL
          key: 'dns_query_time.sh["{$WEB.URL}"]'
          value_type: FLOAT
          units: milliseconds
          timeout: 30s
          triggers:
            - uuid: bd477815446144de9d054497506163ee
              expression: 'min(/Website Monitoring by Vector/dns_query_time.sh["{$WEB.URL}"],#3)> {$DNS.QUERY.WARN}'
              recovery_mode: RECOVERY_EXPRESSION
              recovery_expression: 'min(/Website Monitoring by Vector/dns_query_time.sh["{$WEB.URL}"],#3)<{$DNS.QUERY.WARN}'
              name: 'DNS Query Time is High'
              event_name: 'DNS Query Time is High for {$WEB.URL} (More than {$DNS.QUERY.WARN} milliseconds)'
              opdata: 'DNS Query Time: {ITEM.LASTVALUE}'
              priority: WARNING
              description: 'DNS Query Time is Higher then expected Value.'
              tags:
                - tag: Severity
                  value: Warning
        - uuid: d5bacecb972c48d29b83d0e4777cd559
          name: 'HTTP Probe Duration'
          type: EXTERNAL
          key: 'http_probe.sh[{$WEB.URL}]'
          value_type: FLOAT
          units: milliseconds
          timeout: 30s
          triggers:
            - uuid: e17413d9b35e433193514e65ac4a7dc2
              expression: 'min(/Website Monitoring by Vector/http_probe.sh[{$WEB.URL}],#2)>{$HTTP.PROBE.WARN}'
              recovery_mode: RECOVERY_EXPRESSION
              recovery_expression: 'min(/Website Monitoring by Vector/http_probe.sh[{$WEB.URL}],#2)<{$HTTP.PROBE.WARN}'
              name: 'HTTP Probe Duration is High'
              event_name: 'HTTP Probe Duration is High for {$WEB.URL} (More than {$HTTP.PROBE.WARN} milliseconds)'
              opdata: 'HTTP Probe Duration: {ITEM.LASTVALUE}'
              priority: WARNING
              description: 'HTTP Probe Duration s Higher then expected Value.'
              tags:
                - tag: Severity
                  value: Warning
        - uuid: edc778b857d648db9daf985979b8e241
          name: 'HTTP Version'
          type: EXTERNAL
          key: 'http_version.sh["{$WEB.URL}"]'
          delay: 1d
          value_type: TEXT
          trends: '0'
          timeout: 30s
        - uuid: d224b22f8e8e4a4f97d008f0ef812407
          name: 'Page Load Time'
          type: EXTERNAL
          key: 'page_load_time.sh[{$WEB.URL}]'
          value_type: FLOAT
          units: Seconds
          timeout: 30s
          triggers:
            - uuid: 281238f9e7ce491db1c2b05e9922ba42
              expression: 'min(/Website Monitoring by Vector/page_load_time.sh[{$WEB.URL}],#2)>{$PAGE.LOAD.WARN}'
              recovery_mode: RECOVERY_EXPRESSION
              recovery_expression: 'min(/Website Monitoring by Vector/page_load_time.sh[{$WEB.URL}],#2)<{$PAGE.LOAD.WARN}'
              name: 'Page Load Time is High'
              event_name: 'Page Load Time is High for {$WEB.URL} (More than {$PAGE.LOAD.WARN} Seconds)'
              opdata: 'Page Load Time: {ITEM.LASTVALUE}'
              priority: WARNING
              description: 'Page Load Time is Higher then expected Value.'
              tags:
                - tag: Severity
                  value: Warning
        - uuid: db8dbc0858d44e1eba322f78dae94dbf
          name: 'Status Code'
          type: DEPENDENT
          key: status.code
          delay: '0'
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.code
              error_handler: DISCARD_VALUE
          master_item:
            key: 'vu_statuscode.py[{$WEB.URL}]'
          triggers:
            - uuid: 11fbd28030754f80bccf7a163640c817
              expression: 'min(/Website Monitoring by Vector/status.code,#3)<>200'
              recovery_mode: RECOVERY_EXPRESSION
              recovery_expression: 'min(/Website Monitoring by Vector/status.code,#3)=200'
              name: 'Website not available'
              event_name: '{$WEB.URL} is not available'
              opdata: 'Status: {ITEM.LASTVALUE}'
              priority: HIGH
              tags:
                - tag: Severity
                  value: High
        - uuid: 9bce5c8565d348daad51e85d735efd66
          name: 'Status ID'
          type: DEPENDENT
          key: status.id
          delay: '0'
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.status
              error_handler: DISCARD_VALUE
          master_item:
            key: 'vu_statuscode.py[{$WEB.URL}]'
        - uuid: 4d63c9fc946e4df2ae51dbe2508ff845
          name: 'Total links'
          type: DEPENDENT
          key: total.link.count
          delay: '0'
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.Total_links
          master_item:
            key: 'vu_blk.py[{$WEB.URL}]'
        - uuid: eede564bf5314312b3ebfcc2f9cb3cb4
          name: 'RAW BLK'
          type: EXTERNAL
          key: 'vu_blk.py[{$WEB.URL}]'
          delay: 15m
          history: 7d
          value_type: LOG
          trends: '0'
          timeout: 180s
        - uuid: 5c36ace659d1485684b3afc49b4379dd
          name: 'Download Speed'
          type: EXTERNAL
          key: 'vu_downloadspeed.py[{$WEB.URL}]'
          value_type: FLOAT
          units: Kbps
          timeout: 30s
          triggers:
            - uuid: 083a6d3205f047f0a470cec66eb2bd9c
              expression: 'min(/Website Monitoring by Vector/vu_downloadspeed.py[{$WEB.URL}],#2)< {$DOWNLOAD.SPEED.WARN}'
              recovery_mode: RECOVERY_EXPRESSION
              recovery_expression: 'min(/Website Monitoring by Vector/vu_downloadspeed.py[{$WEB.URL}],#2)>{$DOWNLOAD.SPEED.WARN}'
              name: 'Download Speed is Low'
              event_name: 'Download Speed is Low for {$WEB.URL} (Less than {$DOWNLOAD.SPEED.WARN} Kbps)'
              opdata: 'Download Speed : {ITEM.LASTVALUE}'
              priority: WARNING
              description: 'Download Speed is Higher then expected Value.'
              tags:
                - tag: Severity
                  value: Warning
        - uuid: 2bb51eb63c2a4c1ba9b31a5fa0947ac6
          name: 'Reach Time'
          type: EXTERNAL
          key: 'vu_reachtime.py[{$WEB.URL}]'
          value_type: FLOAT
          units: Seconds
          timeout: 30s
          triggers:
            - uuid: 6b9b3dd2955446109f1bb6897e6ff1ce
              expression: 'min(/Website Monitoring by Vector/vu_reachtime.py[{$WEB.URL}],#2)>{$REACH.TIME.WARN}'
              recovery_mode: RECOVERY_EXPRESSION
              recovery_expression: 'min(/Website Monitoring by Vector/vu_reachtime.py[{$WEB.URL}],#2)<{$REACH.TIME.WARN}'
              name: 'Reach Time is High'
              event_name: 'Reach Time is High for {$WEB.URL} (More than {$REACH.TIME.WARN} Seconds)'
              opdata: 'Reach Time: {ITEM.LASTVALUE}'
              priority: WARNING
              description: 'Reach Time is Higher then expected Value.'
              tags:
                - tag: Severity
                  value: Warning
        - uuid: 48c8e5d0f5b54cf098f627245a243d78
          name: 'Web Report'
          type: EXTERNAL
          key: 'vu_report.py[{HOST.NAME}]'
          delay: 1d
          history: 1d
          value_type: LOG
          trends: '0'
          timeout: 30s
        - uuid: 7bc680df553c46dabf40b6a620273fe4
          name: 'SSL Handshake Time'
          type: EXTERNAL
          key: 'vu_ssl_handshake.py[{$WEB.URL}]'
          value_type: FLOAT
          units: Seconds
          timeout: 30s
          triggers:
            - uuid: d503bd830ecc46bab83bb3a59800419f
              expression: 'min(/Website Monitoring by Vector/vu_ssl_handshake.py[{$WEB.URL}],#2)>{$SSL.HANDSHAKE.WARN}'
              recovery_mode: RECOVERY_EXPRESSION
              recovery_expression: 'min(/Website Monitoring by Vector/vu_ssl_handshake.py[{$WEB.URL}],#2)<{$SSL.HANDSHAKE.WARN}'
              name: 'SSL Handshake Time is High'
              event_name: 'SSL Handshake Time is High for {$WEB.URL} (More than {$SSL.HANDSHAKE.WARN} Seconds)'
              opdata: 'SSL Handshake Time: {ITEM.LASTVALUE}'
              priority: WARNING
              description: 'SSL Handshake Time is Higher then expected Value.'
              tags:
                - tag: Severity
                  value: Warning
        - uuid: 2b5da0b1119e43439bfc570646ed6a60
          name: 'Raw Status'
          type: EXTERNAL
          key: 'vu_statuscode.py[{$WEB.URL}]'
          delay: 15s
          value_type: TEXT
          trends: '0'
          timeout: 120s
        - uuid: ac85b1a8cc5942238d8995efda1727cc
          name: 'Time to First Byte'
          type: EXTERNAL
          key: 'vu_ttfb.py[{$WEB.URL}]'
          value_type: FLOAT
          units: Seconds
          timeout: 30s
          triggers:
            - uuid: d5a64c6663394d5d81b351bce9bec886
              expression: 'min(/Website Monitoring by Vector/vu_ttfb.py[{$WEB.URL}],#2)>{$TTFB.WARN}'
              recovery_mode: RECOVERY_EXPRESSION
              recovery_expression: 'min(/Website Monitoring by Vector/vu_ttfb.py[{$WEB.URL}],#2)<{$TTFB.WARN}'
              name: 'Time to First Byte Time is High'
              event_name: 'Time to First Byte Time is High for {$WEB.URL} (More than {$TTFB.WARN} Seconds)'
              opdata: 'Time to First Byte Time: {ITEM.LASTVALUE}'
              priority: WARNING
              description: 'Time to First Byte Time is Higher then expected Value.'
              tags:
                - tag: Severity
                  value: Warning
        - uuid: 1a7ba1c386694180a45c7b05a6061c05
          name: 'Website Downtime Count'
          type: DEPENDENT
          key: web.down.count
          delay: '0'
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.data.downtimecount
              error_handler: DISCARD_VALUE
          master_item:
            key: 'vu_report.py[{HOST.NAME}]'
        - uuid: 4d8a0f14b6fd41f2a51482c24e042a3d
          name: 'Website Downtime in MM:SS'
          type: DEPENDENT
          key: web.down.time
          delay: '0'
          value_type: FLOAT
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.data.downtime
              error_handler: DISCARD_VALUE
          master_item:
            key: 'vu_report.py[{HOST.NAME}]'
      discovery_rules:
        - uuid: f8359eb952144a18b2b1c21a9beb71a2
          name: 'Ports Discovery'
          type: EXTERNAL
          key: 'vu_ports.py[{$WEB.URL}]'
          delay: 1d
          lifetime_type: DELETE_NEVER
          lifetime: '0'
          enabled_lifetime_type: DISABLE_NEVER
          timeout: 380s
          lld_macro_paths:
            - lld_macro: '{#PORT.NUMBER}'
              path: $.port_number
            - lld_macro: '{#VULNERABILITY}'
              path: $.vulnerability
          preprocessing:
            - type: JSONPATH
              parameters:
                - '$.data[*]'
              error_handler: DISCARD_VALUE
        - uuid: 85cd9eedef1b4e4f821a8062f0aa8ed5
          name: 'WT Discovery'
          type: SCRIPT
          key: wt.discovery
          delay: 5m
          params: |
            var obj = JSON.parse(value);
                   var data = obj.wtdata;
                   return data
          lifetime_type: DELETE_NEVER
          lifetime: '0'
          enabled_lifetime_type: DISABLE_NEVER
          item_prototypes:
            - uuid: 13d21dbcaecd405d9976afe429b560cf
              name: '{#PAGE.NAME} page DNS Time'
              type: DEPENDENT
              key: 'dns.time[{#PAGE.NAME}]'
              delay: '0'
              value_type: FLOAT
              trends: '0'
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - $.performance_data.summary.navigation.dns_lookup_time
                  error_handler: CUSTOM_VALUE
                  error_handler_params: '0'
                - type: MULTIPLIER
                  parameters:
                    - '0.001'
              master_item:
                key: 'website.get.data[{#URL}]'
              tags:
                - tag: page
                  value: '{#PAGE.NAME}'
            - uuid: 40e39af8a8d24342b32fd527edf892cb
              name: '{#PAGE.NAME} page Load Time'
              type: DEPENDENT
              key: 'load.time[{#PAGE.NAME}]'
              delay: '0'
              value_type: FLOAT
              trends: '0'
              units: s
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - $.performance_data.summary.navigation.load_finished
                  error_handler: DISCARD_VALUE
                - type: MULTIPLIER
                  parameters:
                    - '0.001'
              master_item:
                key: 'website.get.data[{#URL}]'
              tags:
                - tag: page
                  value: '{#PAGE.NAME}'
            - uuid: b9fb9e0194b249a390dee5a87c57052f
              name: '{#PAGE.NAME} TCP handshake time'
              type: DEPENDENT
              key: 'response.time[{#PAGE.NAME}]'
              delay: '0'
              value_type: FLOAT
              trends: '0'
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - $.performance_data.summary.navigation.tcp_handshake_time
                  error_handler: DISCARD_VALUE
                - type: MULTIPLIER
                  parameters:
                    - '0.001'
              master_item:
                key: 'website.get.data[{#URL}]'
              tags:
                - tag: page
                  value: '{#PAGE.NAME}'
            - uuid: 488261ee68fc4764a4f0925f80be73ad
              name: '{#PAGE.NAME} page Screenshot'
              type: DEPENDENT
              key: 'screenshot[{#PAGE.NAME}]'
              delay: '0'
              value_type: TEXT
              trends: '0'
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - $.screenshot
                  error_handler: DISCARD_VALUE
              master_item:
                key: 'website.get.data[{#URL}]'
              tags:
                - tag: page
                  value: '{#PAGE.NAME}'
            - uuid: 1f2bedf6d6994d7b8f3438e323742f5e
              name: 'WT RAW for {#PAGE.NAME}'
              type: BROWSER
              key: 'website.get.data[{#URL}]'
              delay: 15m
              value_type: TEXT
              trends: '0'
              params: |
                const Website = {
                    params: {},
                
                    setParams(params) {
                        ['scheme', 'domain','width', 'height'].forEach(function (field) {
                            if (typeof params !== 'object' || !params[field]) {
                                throw new Error('Required param is not set: ' + field + '.');
                            }
                        });
                        this.params = params;
                    },
                
                    getOptions(browser) {
                        switch ((browser || '').trim().toLowerCase()) {
                            case 'firefox':
                                return Browser.firefoxOptions();
                            case 'safari':
                                return Browser.safariOptions();
                            case 'edge':
                                return Browser.edgeOptions();
                            default:
                                return Browser.chromeOptions();
                        }
                    },
                
                    getPerformance() {
                        const browser = new Browser(Website.getOptions(Website.params.browser));
                        const url = Website.params.scheme + '://' + Website.params.domain + '/' + Website.params.path
                        const screenshot = '';
                        browser.setScreenSize(Number(Website.params.width), Number(Website.params.height))
                        browser.navigate(url);
                        browser.collectPerfEntries();
                        screenshot = browser.getScreenshot();
                        const result = browser.getResult();
                        result.screenshot = screenshot;
                
                        return JSON.stringify(result);
                    }
                };
                
                try {
                    Website.setParams(JSON.parse(value));
                    return Website.getPerformance();
                
                } catch (error) {
                    error += (String(error).endsWith('.')) ? '' : '.';
                    Zabbix.log(3, '[ Website get metrics] ERROR: ' + error);
                    return JSON.stringify({ 'error': error });
                }
              description: '{#URL}'
              preprocessing:
                - type: CHECK_NOT_SUPPORTED
                  parameters:
                    - '-1'
              timeout: 180s
              parameters:
                - name: browser
                  value: '{$WEBSITE.BROWSER}'
                - name: domain
                  value: '{#URL}'
                - name: height
                  value: '{$WEBSITE.SCREEN.HEIGHT}'
                - name: path
                  value: '{$WEBSITE.PATH}'
                - name: scheme
                  value: '{$WEBSITE.SCHEME}'
                - name: width
                  value: '{$WEBSITE.SCREEN.WIDTH}'
              tags:
                - tag: component
                  value: raw
                - tag: page
                  value: '{#PAGE.NAME}'
          timeout: 30s
          parameters:
            - name: wtdata
              value: '{$WT.DATA}'
          lld_macro_paths:
            - lld_macro: '{#PAGE.NAME}'
              path: $.page_name
            - lld_macro: '{#URL}'
              path: $.url
          preprocessing:
            - type: JSONPATH
              parameters:
                - '$.data[*]'
              error_handler: DISCARD_VALUE
      httptests:
        - uuid: c80008b60f934853999b7ac74c4a8aa7
          name: 'Web Health Check'
          delay: 15s
          steps:
            - name: 'health check'
              url: 'https://{$WEB.URL}'
      tags:
        - tag: class
          value: application
        - tag: class
          value: website
        - tag: target
          value: websites
      macros:
        - macro: '{$CERT.EXPIRY.WARN}'
          description: 'Provide Threshold Value in Days'
        - macro: '{$DNS.QUERY.WARN}'
          description: 'Provide Threshold Value in ms'
        - macro: '{$DOWNLOAD.SPEED.WARN}'
          description: 'Provide Threshold Value in Kbps'
        - macro: '{$HTTP.PROBE.WARN}'
          description: 'Provide Threshold Value in ms'
        - macro: '{$PAGE.LOAD.WARN}'
          description: 'Provide Threshold Value in Seconds'
        - macro: '{$REACH.TIME.WARN}'
          description: 'Provide Threshold Value in Seconds'
        - macro: '{$RESPONSE.TIME.WARN}'
          description: 'Provide Threshold Value in ms'
        - macro: '{$SSL.HANDSHAKE.WARN}'
          description: 'Provide Threshold Value in seconds'
        - macro: '{$TTFB.WARN}'
          description: 'Provide Threshold Value'
        - macro: '{$WEB.URL}'
          description: 'Provide Threshold Value'
        - macro: '{$WEBSITE.BROWSER}'
          value: chrome
        - macro: '{$WEBSITE.NAVIGATION.LOAD.MAX.WARN}'
          value: '5'
        - macro: '{$WEBSITE.PATH}'
          value: /
        - macro: '{$WEBSITE.SCHEME}'
          value: https
        - macro: '{$WEBSITE.SCREEN.HEIGHT}'
          value: '1080'
        - macro: '{$WEBSITE.SCREEN.WIDTH}'
          value: '1920'
        - macro: '{$WT.DATA}'
          description: '{   "data": [     {       "page_name": "<name of your website page>",       "url": "<link of your page>"     },     {       "page_name": "<name of second page>",       "url": "<link of second page>"     }   ] }'
      dashboards:
        - uuid: 6a361ae7b5eb48658225faf4db9eca39
          name: 'ImgNew dashboard'
          pages:
            - widgets:
                - type: itemhistory
                  name: Screenshot
                  width: '18'
                  height: '6'
                  fields:
                    - type: ITEM
                      name: columns.0.itemid
                      value:
                        host: 'Website Monitoring by Vector'
                        key: 'vu_report.py[{HOST.NAME}]'
                    - type: STRING
                      name: columns.0.name
                      value: Screenshot
                    - type: STRING
                      name: reference
                      value: UOMJS
  triggers:
    - uuid: 49a21c163a1846279d236df2afaf4764
      expression: 'min(/Website Monitoring by Vector/web.test.time[Web Health Check,health check,resp],#2)>{$RESPONSE.TIME.WARN}'
      recovery_mode: RECOVERY_EXPRESSION
      recovery_expression: 'min(/Website Monitoring by Vector/web.test.time[Web Health Check,health check,resp],#2)<{$RESPONSE.TIME.WARN}'
      name: 'Response Time is High'
      event_name: 'Response  Time is High for {$WEB.URL} (More than {$RESPONSE.TIME.WARN} milliseconds)'
      opdata: 'Response Time: {ITEM.LASTVALUE}'
      priority: WARNING
      description: 'Response Time is Higher then expected Value.'
      tags:
        - tag: Severity
          value: Warning
